# PHP-FPM

## 用信号控制：

master进程可以理解以下信号

- INT, TERM 立刻终止
- QUIT 平滑终止
- USR1 重新打开日志文件
- USR2 平滑重载所有worker进程并重新载入配置和二进制模块

```shell
ps aux|grep php-fpm
kill -USR2 主进程号
```

## 开启慢请求日志

```conf
request_slowlog_timeout = 1
```

## 开启错误日志

`/etc/php/7.1/fpm/php.ini`设置
```ini
display_errors = On
log_errors = On
error_log = /var/log/php-error.log
error_reporting=E_ALL&~E_NOTICE
```

`/etc/php/7.1/fpm/php-fpm.conf`最后增加
```conf
[global]
; Note: the default prefix is /usr/local/php/var
error_log = log/php_error_log
```

`/etc/php/7.1/fpm/pool.d/www.conf`去掉注释：
```conf
[www]
catch_workers_output = yes
```

`catch_workers_output = yes` 一定要放在对应的`[www]`组下，修改完重启。可以通过`phpinfo()`查看日志文件地址。
```conf
catch_workers_output = yes
php_flag[display_errors] = on
php_admin_value[error_log] = /var/log/php-fpm/default/error.log
php_admin_flag[log_errors] = on
```

## Nginx 设置

```conf
http {
    upstream fastcgiserver {
            server unix:/run/php/php7.0-fpm.sock;
            server unix:/run/php/php7.1-fpm.sock;
    }
}

server {
    try_files $uri $uri/ @rewrite;

    location @rewrite {
            rewrite ^/(.*)$ /index.php?_url=/$1;
    }

    location ~ \.php {
            fastcgi_pass fastcgiserver;
            fastcgi_index /index.php;

            include /etc/nginx/fastcgi_params;

            fastcgi_split_path_info    ^(.+\.php)(/.+)$;
            fastcgi_param PATH_INFO    $fastcgi_path_info;
            fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}

server {
        listen 9090;
        server_name localhost;

        # SSL configuration
        #
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        include snippets/snakeoil.conf;

        index index.php index.html index.htm;
        set $root_path '/var/www/html/12mobi/public/';
        root $root_path;

        location / {
                try_files $uri $uri/ /index.php?$query_string;
        }

        location /ngx_status {
                stub_status on;
                access_log off;
                #allow 127.0.0.1;
                #deny all;
        }

        location ~ \.php$ {
                fastcgi_buffer_size 128k;
                fastcgi_buffers 4 256k;
                fastcgi_busy_buffers_size 256k;
                fastcgi_temp_file_write_size 256k;
                fastcgi_send_timeout 900;
                fastcgi_read_timeout 900;
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass 127.0.0.1:9000;
                fastcgi_index index.php;
                fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
                include fastcgi_params;
        }

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;

        #       # With php7.0-cgi alone:
        #       fastcgi_pass 127.0.0.1:9000;
                # With php7.0-fpm:
                fastcgi_pass unix:/run/php/php7.1-fpm.sock;
        }
}
```

## 启动脚本

`/etc/init.d/php7-fpm`

```shell
#!/bin/bash

php_command=/usr/local/php7/sbin/php-fpm
php_config=/usr/local/php7/etc/php-fpm.conf
php_pid=/usr/local/php7/var/run/php-fpm.pid
RETVAL=0
prog="php-fpm"

#start function
php_fpm_start() {
    /usr/local/php7/sbin/php-fpm
}

start(){
    if [ -e $php_pid  ]
    then
    echo "php-fpm already start..."
    exit 1
    fi
    php_fpm_start
}

stop(){
    if [ -e $php_pid ]
    then
    parent_pid=`cat $php_pid`
    all_pid=`ps -ef | grep php-fpm | awk '{if('$parent_pid' == $3){print $2}}'`
    for pid in $all_pid
    do
            kill $pid
        done
        kill $parent_pid
    fi
    exit 1
}

restart(){
    stop
    start
}

# See how we were called.
case "$1" in
start)
        start
        ;;
stop)
        stop
        ;;
restart)
        stop
        start
        ;;
status)
        status $prog
        RETVAL=$?
        ;;
*)
        echo $"Usage: $prog {start|stop|restart|status}"
        exit 1
esac
exit $RETVAL
```

```shell
sudo apt-get install chkconfig
sudo ln -s /usr/lib/insserv/insserv /sbin/

##  添加执行权限  
chmod a+x /etc/init.d/php7-fpm

##  加入服务
chkconfig --add php7-fpm

##   开机自启  
chkconfig php7-fpm on
```

## 开启 php-fpm 生成 core dumps

切换到 root 用户修改：

```shell
su -
echo '/tmp/core-%e.%p' > /proc/sys/kernel/core_pattern
echo 0 > /proc/sys/kernel/core_uses_pid
ulimit -c unlimited
```

设置 `/etc/php-fpm.d/www.conf`

```conf
rlimit_core = unlimited
```

```shell
gdb /path/to/php-fpm core.dump
```
