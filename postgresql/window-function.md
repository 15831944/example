# 窗口函数

窗口函数提供跨行相关的当前查询行集执行计算的能力。 参阅第 3.5 节获取这个特性的介绍。

表 9-48列出了内建的窗口函数。 注意必须使用窗口函数的语法调用这些函数；一个OVER子句是必需的。

除了这些函数外，任何内建的或用户定义的聚合函数都可以作为窗口函数（见 第 9.20 节关于内建聚合函数的列表）。 仅当调用跟着OVER子句的聚合函数，作为窗口函数；否则它们作为常规的聚合。

表 9-48. 通用窗口函数

- row_number()
在其分区中的当前行号，从1计

- rank()
有间隔的当前行排名；与它的第一个相同行的row_number相同

- dense_rank()
没有间隔的当前行排名；这个函数计数对等组。

- percent_rank()
当前行的相对排名: (rank - 1) / (总行数 - 1)

- cume_dist()
当前行的相对排名：(前面的行数或与当前行相同的行数)/(总行数)

- ntile(num_buckets integer)
从1到参数值的整数范围，尽可能相等的划分分区。

- lag(value any [, offset integer [, default any ]])
计算分区当前行的前offset 行，返回value 。如果没有这样的行， 返回default替代。 offset和default 都是当前行计算的结果。如果忽略了，则offset 默认是1，default默认是 null。

- lead(value any [, offset integer [, default any ]])
计算分区当前行的后offset行， 返回value。如果没有这样的行， 返回default替代。 offset和default 都是当前行计算的结果。如果忽略了，则offset 默认是1，default默认是 null。

- first_value(value any)
返回窗口第一行的计算value值。

- last_value(value any)
返回窗口最后一行的计算value值。

- nth_value(value any, nth integer)
返回窗口第nth行的计算 value值（行从1计数）；没有这样的行则返回 null。

在表 9-48 列出的所有函数，依赖于与窗口定义有关的`ORDER BY`子句指定的排序。同行是说在`ORDER BY`排序时不唯一的行。定义的这四个排名函数，对于任何两个同行的答案相同。

注意`first_value`，`last_value`，和`nth_value` 只考虑`window frame`内的行，其默认情况下，包含从分区的开始行直到当前行的最后同行。 像last_value和nth_value有时会给出没有用的结果。 您可以通过向OVER子句添加合适的框架规范（RANGE或者ROWS） 来重新定义该框架。

当一个聚合函数作为窗口函数使用时，将聚合超过当前行的窗框内的行。一个使用ORDER BY和默认窗框定义处理"运行时求和"类型的行为的聚合函数， 可能不是想要的结果。为了获取超过整个分区聚合，忽略ORDER BY 或者使用ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING。 其它窗框规格可以用来获取其它的效果。

## 窗口调用函数

通过查询筛选出的行的某些部分，窗口调用函数实现了类似于聚合函数的功能。 不同的是，窗口调用函数不需要将查询结果打包成一行输出—在查询输出中，每一行都是分开的。 然而，窗口调用函数可以扫描所有的行，根据窗口调用函数的分组规范(PARTITION BY列)， 这些行可能会是当前行所在组的一部分。一个窗口调用函数的语法是下列之一：

- function_name ([expression [, expression ... ]]) OVER ( window_definition )
- function_name ([expression [, expression ... ]]) OVER window_name
- function_name ( * ) OVER ( window_definition )
- function_name ( * ) OVER window_name

这里的window_definition具有如下语法：

- [ existing_window_name ]
- [ PARTITION BY expression [, ...] ]
- [ ORDER BY expression [ ASC | DESC | USING operator ] [ NULLS { FIRST | LAST } ] [, ...] ]
- [ frame_clause ]

选项frame_clause可以是：

- [ RANGE | ROWS ] frame_start
- [ RANGE | ROWS ] BETWEEN frame_start AND frame_end

frame_start 和 frame_end可以是：

- UNBOUNDED PRECEDING
- value PRECEDING
- CURRENT ROW
- value FOLLOWING
- UNBOUNDED FOLLOWING

在这里，expression 表示的是任何自己不含窗口调用函数的值表达式。

window_name引用的是查询语句中WINDOW 子句定义的命名窗口规范。命名窗口规范通常只是用OVER window_name 来引用，但它也可以在括号里写一个窗口名，并且可以有选择的使用排序和/或框架(frame）子句 （如果应用这些子句的话，那么被引用的窗口必须不能有这些子句）。 后者语法遵循相同的规则（修改WINDOW子句中已有的窗口名）。 参阅SELECT查看更多资料。

PARTITION BY选项将查询的行分为一组进入partitions， 这些行在窗口函数中单独处理。PARTITION BY和查询级别GROUP BY 子句做相似的工作，除了它的表达式只能作为表达式不能作为输出列的名字或数。 没有PARTITION BY，所有由查询产生的行被视为一个单独的分区。ORDER BY 选项决定分区中的行被窗口函数处理的顺序。它和查询级别ORDER BY子句做相似的工作， 但是同样的它不能作为输出列的名字或数。没有ORDER BY，行以一个不被预知的顺序处理。

对这些窗口函数（在这个框架而不是整个分区上的）， frame_clause指定构成window frame的行， 他们是当前分区的一个子集。框架可以用RANGE 或 ROWS模式声明；不管哪种情况， 它的变化范围是从frame_start到frame_end。如果省略了frame_end 默认为CURRENT ROW。

一个frame_start的UNBOUNDED PRECEDING意味着框架从分区中的第一行开始， 相似的，一个frame_end的UNBOUNDED FOLLOWING意味着框架从分区中的最后一行结束。

在RANGE模式中，frame_start的CURRENT ROW 意味着框架从当前行的第一个peer行开始（ORDER BY 认为等于当前行的行），而frame_end的CURRENT ROW 意味着框架从最后一个同等的行结束。在ROWS模式中， CURRENT ROW 简单的意味着当前行。

value PRECEDING和value FOLLOWING 当前只允许ROWS模式。这也就意味着，框架从当前行之前或之后指定的行数启动或结束。 value必须是整型表达式，而不能包含变量，聚合函数，或者窗口函数。 该值不能为空或负，但可以是零，表示只选择当前行本身。

默认的框架选项是RANGE UNBOUNDED PRECEDING，该选项与 RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW相同。有ORDER BY， 它设置框架从分区的开始一直到与当前行相同的最后一行。没有ORDER BY， 那么就是当前分区的所有行都包含在框架中，因为所有行都会成为当前行的相同行。

限制条件是frame_start不能为UNBOUNDED FOLLOWING， frame_end不能为UNBOUNDED PRECEDING，并且frame_end 选项不能在上面的列表中出现的比frame_start选项早—例如 RANGE BETWEEN CURRENT ROW AND value PRECEDING是不被允许的。

内置窗口函数在表 9-48中有描述。其他窗口函数， 用户可以自己添加。同样，任意内置或用户自定义聚合函数可以同窗口函数一样使用。

使用*的语法可以用来调用无参数的聚合函数为窗口函数，如 count(*) OVER (PARTITION BY x ORDER BY y)。星号(*) 通常不用于非聚合的窗口函数。与通常的聚合函数不同，聚合窗口函数不允许在函数参数列中使用 DISTINCT或ORDER BY。

窗口调用函数只能在SELECT列，或者查询的ORDER BY子句中使用。 

## 教程

See http://www.postgres.cn/docs/9.3/tutorial-window.html

PostgreSQL 提供了窗口函数的特性。窗口函数也是计算一些行集合（多个行组成的集合，我们称之为窗口window frame）的数据，有点类似与聚集函数（aggregate function）。但和常规的聚集函数不同的是，窗口函数不会将参与计算的行合并成一行输出，而是保留它们原来的样子。

有一个表示员工薪资的表（部门、员工id，工资）：

```text
postgres=# d empsal 
          Table "public.empsal"
 Column  |       Type        | Modifiers 
---------+-------------------+-----------
 depname | character varying | 
 empno   | integer           | 
 salary  | integer           |
```

表内现在有如下数据：

```text
postgres=# select * from empsal ;
  depname  | empno | salary 
-----------+-------+--------
 develop   |    11 |   5200
 develop   |     7 |   4200
 develop   |     9 |   4500
 develop   |     8 |   6000
 develop   |    10 |   5200
 personnel |     5 |   3500
 personnel |     2 |   3900
 sales     |     3 |   4800
 sales     |     1 |   5000
 sales     |     4 |   4800
(10 rows)
```

我们现在想将每个员工的工资与他所在部门的平均工资进行比较，SQL语句该如何写？利用窗口函数，该查询可以很容易的实现：

```text
postgres=# SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname) FROM empsal;
  depname  | empno | salary |          avg          
-----------+-------+--------+-----------------------
 develop   |    11 |   5200 | 5020.0000000000000000
 develop   |     7 |   4200 | 5020.0000000000000000
 develop   |     9 |   4500 | 5020.0000000000000000
 develop   |     8 |   6000 | 5020.0000000000000000
 develop   |    10 |   5200 | 5020.0000000000000000
 personnel |     5 |   3500 | 3700.0000000000000000
 personnel |     2 |   3900 | 3700.0000000000000000
 sales     |     3 |   4800 | 4866.6666666666666667
 sales     |     1 |   5000 | 4866.6666666666666667
 sales     |     4 |   4800 | 4866.6666666666666667
(10 rows)
```

可以看到，聚集函数`avg`的含义没有变，仍然是求平均值。但和普通的聚集函数不同的是，它不再对表中所有的salary求平均值，而是对同一个部门（PARTITION BY指定的depname）内的salary求平均值，而且得到的结果由同一个部门内的所有行共享，并没有将这些行合并。为了更好的体现普通聚集函数与窗口函数中的聚集函数的区别，再看下面的两个查询：

```text
postgres=# SELECT avg(salary) FROM empsal;
          avg          
-----------------------
 4710.0000000000000000
(1 row)

postgres=# SELECT avg(salary) OVER (PARTITION BY depname) FROM empsal;
          avg          
-----------------------
 5020.0000000000000000
 5020.0000000000000000
 5020.0000000000000000
 5020.0000000000000000
 5020.0000000000000000
 3700.0000000000000000
 3700.0000000000000000
 4866.6666666666666667
 4866.6666666666666667
 4866.6666666666666667
(10 rows)
```

窗口函数总是包含`OVER`子句，它指定了窗口函数的名字和参数，也是由这个关键字来区分常规聚集函数和窗口函数。OVER子句里面的内容决定窗口函数即将处理的数据该如何划分。在OVER子句里面我们使用PARTITION BY将数据划分成一个个的组（或者称之为分区）。聚集函数处理的时候以分区为单位进行处理，处理结果也由同一个分区内的所有行共享。比如上面的例子，PARTITION BY后面跟着的字段是depname，所以avg函数将以部门为单位进行计算。其实，这个分区就是窗口（window frame），这也是窗口函数名字的由来。

我们还可以在一个窗口中使用ORDER BY来对输出进行排序：

```text
postgres=# SELECT depname, empno, salary, rank() OVER (PARTITION BY depname ORDER BY salary DESC) FROM empsal;
  depname  | empno | salary | rank 
-----------+-------+--------+------
 develop   |     8 |   6000 |    1
 develop   |    10 |   5200 |    2
 develop   |    11 |   5200 |    2
 develop   |     9 |   4500 |    4
 develop   |     7 |   4200 |    5
 personnel |     2 |   3900 |    1
 personnel |     5 |   3500 |    2
 sales     |     1 |   5000 |    1
 sales     |     3 |   4800 |    2
 sales     |     4 |   4800 |    2
(10 rows)
```

窗口函数处理的行来自于FROM子句产生的“virtual table”，如果还有WHERE、GROUP BY、HAVING子句的话，还要经过这些条件的过滤，符合条件的子句才会作为窗口函数的输入。另外，一个查询可以包含多个窗口函数。

刚才提到，我们使用PARTITION BY来划分窗口，如果省略了该关键字，那么整个表将作为一个窗口来处理：

```text
postgres=# SELECT salary, sum(salary) OVER () FROM empsal;
 salary |  sum  
--------+-------
   5200 | 47100
   4200 | 47100
   4500 | 47100
   6000 | 47100
   5200 | 47100
   3500 | 47100
   3900 | 47100
   4800 | 47100
   5000 | 47100
   4800 | 47100
(10 rows)
```

但是，需要注意的是，如果在OVER子句中省略了PARTITION BY但却包含了ORDER BY子句，情况将和上面不太一样：

```text
postgres=# SELECT salary, sum(salary) OVER(ORDER BY salary ) FROM empsal;
 salary |  sum  
--------+-------
   3500 |  3500
   3900 |  7400
   4200 | 11600
   4500 | 16100
   4800 | 25700
   4800 | 25700
   5000 | 30700
   5200 | 41100
   5200 | 41100
   6000 | 47100
(10 rows)
```

从结果可以看出，在省略了PARTITION BY但却包含了ORDER BY子句的情况下，并不是整个表是一个窗口，而是将从最低（此例中是salary，所以这里用最低这个词）的行当前行作为一个窗口。这是要特别注意的。

最后，我们要注意窗口函数使用的场景：

>> 只能在SELECT和ORDER BY子句中使用，不能在任何其他地方使用，比如GROUP BY、HAVING和WHERE子句。这是因为窗口函数的输入是这些子句的输出。这个先后逻辑不可以变。
>> 可以在窗口函数的参数中使用聚集函数，但是不能将窗内函数作为聚集函数的参数。因为窗口函数要在聚集函数之后执行。这个先后逻辑也不能变。

如果我们真的需要将窗口函数作为某个子句的输入的话，我们可以构造一个SELECT子句，比如：

```text
SELECT depname, empno, salary
FROM
  (SELECT depname, empno, salary,
          rank() OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos
     FROM empsal
  ) AS ss
WHERE pos < 3;

postgres=# SELECT depname, empno, salary
postgres-# FROM
postgres-#   (SELECT depname, empno, salary,
postgres(#           rank() OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos
postgres(#      FROM empsal
postgres(#   ) AS ss
postgres-# WHERE pos < 3;
  depname  | empno | salary 
-----------+-------+--------
 develop   |     8 |   6000
 develop   |    10 |   5200
 personnel |     2 |   3900
 personnel |     5 |   3500
 sales     |     1 |   5000
 sales     |     3 |   4800
(6 rows)
```

如果一个查询中包含多个窗口函数，那么我们可以写多个OVER子句，但如果这些窗口函数的作用是一样的，那分开写多个既是一种重复性工作，而且也容易出错。这种情况下，我们可以将窗口里面的内容写成一个WINDOW子句，然后在多个OVER子句中引用。看下例中的两种写法：

第一种：
```text
SELECT sum(salary) OVER (PARTITION BY depname ORDER BY salary DESC), 	   avg(salary) OVER (PARTITION BY depname ORDER BY salary DESC) FROM empsal;

postgres=# SELECT sum(salary) OVER (PARTITION BY depname ORDER BY salary DESC), avg(salary) OVER (PARTITION BY depname ORDER BY salary DESC) FROM empsal;
  sum  |          avg          
-------+-----------------------
  6000 | 6000.0000000000000000
 16400 | 5466.6666666666666667
 16400 | 5466.6666666666666667
 20900 | 5225.0000000000000000
 25100 | 5020.0000000000000000
  3900 | 3900.0000000000000000
  7400 | 3700.0000000000000000
  5000 | 5000.0000000000000000
 14600 | 4866.6666666666666667
 14600 | 4866.6666666666666667
(10 rows)
```

第二种：
```text
SELECT sum(salary) OVER w, avg(salary) OVER w
  FROM empsal
  WINDOW w AS (PARTITION BY depname ORDER BY salary DESC);

postgres=# SELECT sum(salary) OVER w, avg(salary) OVER w
postgres-#   FROM empsal
postgres-#   WINDOW w AS (PARTITION BY depname ORDER BY salary DESC);
  sum  |          avg          
-------+-----------------------
  6000 | 6000.0000000000000000
 16400 | 5466.6666666666666667
 16400 | 5466.6666666666666667
 20900 | 5225.0000000000000000
 25100 | 5020.0000000000000000
  3900 | 3900.0000000000000000
  7400 | 3700.0000000000000000
  5000 | 5000.0000000000000000
 14600 | 4866.6666666666666667
 14600 | 4866.6666666666666667
(10 rows)
```

## 实现 GROUP BY

```sql
WITH summary AS (
    SELECT p.id, 
           p.customer, 
           p.total, 
           ROW_NUMBER() OVER(PARTITION BY p.customer 
                                 ORDER BY p.total DESC) AS rk
      FROM PURCHASES p)
SELECT s.*
  FROM summary s
 WHERE s.rk = 1;
```

## 测试

See http://www.postgres.cn/news/viewone/1/246

* 测试数据

```sql
create table bills 
(
  id serial not null,
  goodsdesc text not null,
  beginunit text not null,
  begincity text not null,
  pubtime timestamp not null,
  amount float8 not null default 0,
  primary key (id)
);

COMMENT ON TABLE bills is '运单记录';
COMMENT ON COLUMN bills.id IS 'id号';
COMMENT ON COLUMN bills.goodsdesc IS '货物名称';
COMMENT ON COLUMN bills.beginunit IS '启运省份';
COMMENT ON COLUMN bills.begincity IS '启运城市';
COMMENT ON COLUMN bills.pubtime IS '发布时间';
COMMENT ON COLUMN bills.amount IS '运费';

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'衣服','海南省','三亚市','2015-10-05 09:32:01',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'建筑设备','福建省','三明市','2015-10-05 07:21:22',ROUND((random()*10000)::NUMERIC,2)); 

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'设备','福建省','三明市','2015-10-05 11:21:54',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'普货','福建省','三明市','2015-10-05 15:19:17',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'5 0铲车，后八轮翻斗车','河南省','三门峡市','2015-10-05 07:53:13',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'鲜香菇2000斤','河南省','三门峡市','2015-10-05 10:38:29',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'旋挖附件38吨','河南省','三门峡市','2015-10-05 10:48:38',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'旋挖附件35吨','河南省','三门峡市','2015-10-05 10:48:38',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'旋挖附件39吨','河南省','三门峡市','2015-10-05 11:38:38',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'设备','上海市','上海市','2015-10-05 07:59:35',ROUND((random()*10000)::NUMERIC,2));

INSERT INTO bills(id,goodsdesc,beginunit,begincity,pubtime,amount) 
VALUES(default,'普货40吨需13米半挂一辆','上海市','上海市','2015-10-05 08:13:59',ROUND((random()*10000)::NUMERIC,2));
```

* 操作实践

`row_number` -- 返回行号,对比值重复时行号不重复不间断，即返回1,2,3,4,5....,不返回1,2,2,4...

```text
test=# select row_number() over(),* from bills limit 2;                                 
 row_number | id | goodsdesc | beginunit | begincity |       pubtime       | amount  
------------+----+-----------+-----------+-----------+---------------------+---------
          1 |  1 | 衣服      | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
          2 |  2 | 建筑设备  | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
(2 rows)

test=# select row_number() over(),* from bills limit 2 offset 2;       
 row_number | id | goodsdesc | beginunit | begincity |       pubtime       | amount  
------------+----+-----------+-----------+-----------+---------------------+---------
          3 |  3 | 设备      | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
          4 |  4 | 普货      | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
(2 rows)
```

按 amount 排序

```text
test=# select row_number() over(partition by tableoid order by amount),* from bills; 
 row_number | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------------+----+------------------------+-----------+-----------+---------------------+---------
          1 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
          2 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
          3 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
          4 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
          5 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
          6 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
          7 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
          8 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
          9 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
         10 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
         11 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
(11 rows)

test=#
```

按 begincity 分组，pubtime 排序，注意红色记录行号不间断

```text
test=# select row_number() over(partition by begincity order by pubtime),* from bills; 
 row_number | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------------+----+------------------------+-----------+-----------+---------------------+---------
          1 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
          1 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
          2 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
          3 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
          1 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
          2 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
          3 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
          4 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
          5 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
          1 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
          2 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

`rank` -- 返回行号,对比值重复时行号重复并间断，即返回1,2,2,4...

```text
test=# select rank() over(partition by begincity order by pubtime),* from bills;           
 rank | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------+----+------------------------+-----------+-----------+---------------------+---------
    1 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
    1 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
    2 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
    3 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
    1 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
    2 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
    3 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
    3 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
    5 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
    1 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
    2 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

`dance_rank` -- 返回行号,对比值重复时行号重复但不间断，即返回1,2,2,3...

```text
test=# select dense_rank() over(partition by begincity order by pubtime),* from bills;    
 dense_rank | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------------+----+------------------------+-----------+-----------+---------------------+---------
          1 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
          1 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
          2 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
          3 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
          1 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
          2 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
          3 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
          3 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
          4 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
          1 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
          2 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

`percent_rank` -- 从当前开始，计算在分组中的比例 (行号-1)*(1/(总记录数-1))

```text
test=# select percent_rank() over(partition by begincity order by id),* from bills;    
 percent_rank | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
--------------+----+------------------------+-----------+-----------+---------------------+---------
            0 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
            0 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
          0.5 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
            1 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
            0 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
         0.25 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
          0.5 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
         0.75 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
            1 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
            0 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
            1 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

```text
test=# select percent_rank() over(partition by begincity order by pubtime),* from bills;      
 percent_rank | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
--------------+----+------------------------+-----------+-----------+---------------------+---------
            0 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
            0 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
          0.5 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
            1 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
            0 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
         0.25 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
          0.5 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
          0.5 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
            1 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
            0 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
            1 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

`cume_dist` -- 返回行数除以记录数值

```text
test=# select ROUND((cume_dist() over(partition by begincity order by id))::NUMERIC,2) AS cume_dist,* from bills;
 cume_dist | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
-----------+----+------------------------+-----------+-----------+---------------------+---------
      1.00 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
      0.33 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
      0.67 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
      1.00 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
      0.20 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
      0.40 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
      0.60 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
      0.80 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
      1.00 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
      0.50 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
      1.00 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=# 
```

`ntile` -- 分组数量，让所有记录尽可以的均匀分布

```text
test=# select ntile(3) over(partition by begincity order by id),* from bills;     
 ntile | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
-------+----+------------------------+-----------+-----------+---------------------+---------
     1 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
     1 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
     2 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
     3 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
     1 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
     1 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
     2 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
     2 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
     3 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
     1 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
     2 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

```text
test=# select ntile(2) over(partition by begincity order by id),* from bills;     
 ntile | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
-------+----+------------------------+-----------+-----------+---------------------+---------
     1 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
     1 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
     1 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
     2 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
     1 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
     1 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
     1 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
     2 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
     2 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
     1 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
     2 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

`lag` -- 返回偏移量值，offset integer是偏移值，正数时前值，负数时后值，没有取到值时用default代替

```text
test=# select lag(amount,1,null) over(partition by begincity order by id),* from bills;  
   lag   | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
---------+----+------------------------+-----------+-----------+---------------------+---------
         |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
         |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
 9370.12 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
 6573.33 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
         |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
 2350.68 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
     549 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
 4089.25 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
 4766.76 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
         |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
 5094.08 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

```text
test=# select lag(amount,1,0::float8) over(partition by begincity order by id),* from bills; 
   lag   | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
---------+----+------------------------+-----------+-----------+---------------------+---------
       0 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
       0 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
 9370.12 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
 6573.33 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
       0 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
 2350.68 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
     549 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
 4089.25 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
 4766.76 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
       0 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
 5094.08 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

```text
test=# select lag(amount,2,0::float8) over(partition by begincity order by id),* from bills;  
   lag   | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
---------+----+------------------------+-----------+-----------+---------------------+---------
       0 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
       0 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
       0 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
 9370.12 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
       0 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
       0 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
 2350.68 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
     549 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
 4089.25 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
       0 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
       0 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

```text
test=#  select lag(amount,-2,0::float8) over(partition by begincity order by id),* from bills; 
   lag   | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
---------+----+------------------------+-----------+-----------+---------------------+---------
       0 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
 1352.16 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
       0 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
       0 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
 4089.25 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
 4766.76 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
 7614.53 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
       0 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
       0 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
       0 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
       0 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

`lead` -- 返回偏移量值，offset integer是偏移值，正数时取后值，负数时取前值，没有取到值时用default代替

```text
test=#  select lead(amount,2,null) over(partition by begincity order by id),* from bills;
  lead   | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
---------+----+------------------------+-----------+-----------+---------------------+---------
         |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
 1352.16 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
         |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
         |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
 4089.25 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
 4766.76 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
 7614.53 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
         |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
         | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
         |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
         | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

```text
test=#  select lead(amount,-2,null) over(partition by begincity order by id),* from bills;
  lead   | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
---------+----+------------------------+-----------+-----------+---------------------+---------
         |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
         |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
         |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
 9370.12 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
         |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
         |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
 2350.68 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
     549 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
 4089.25 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
         |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
         | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)
```

`first_value` -- 返回第一值

```text
test=# select first_value(amount) over(partition by begincity order by  id),* from bills;
 first_value | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
-------------+----+------------------------+-----------+-----------+---------------------+---------
      1569.6 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
     9370.12 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
     9370.12 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
     9370.12 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
     2350.68 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
     2350.68 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
     2350.68 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
     2350.68 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
     2350.68 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
     5094.08 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
     5094.08 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

`last_value` -- 返回最后值

```text
test=# select last_value(amount) over(partition by begincity order by pubtime),* FROM bills;   
 last_value | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------------+----+------------------------+-----------+-----------+---------------------+---------
     1569.6 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
    9370.12 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
    6573.33 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
    1352.16 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
    2350.68 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
        549 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
    4766.76 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
    4766.76 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
    7614.53 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
    5094.08 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
    5333.02 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

```text
test=# select last_value(amount) over(partition by begincity),* FROM bills;            
 last_value | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------------+----+------------------------+-----------+-----------+---------------------+---------
     1569.6 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
    9370.12 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
    9370.12 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
    9370.12 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
    4089.25 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
    4089.25 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
    4089.25 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
    4089.25 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
    4089.25 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
    5094.08 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
    5094.08 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
(11 rows)
```

注意不要加上order by id，默认情况下，带了order by 参数会从分组的起始值开始一直叠加，直到当前值（不是当前记录）不同为止，当忽略order by 参数则是整个分组。下面通过修改分组的统计范围就可以实现order by参数取最后值 

```text
test=# select last_value(amount) over(partition by begincity order by id range between unbounded preceding and 
unbounded following),* FROM bills;
 last_value | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
------------+----+------------------------+-----------+-----------+---------------------+---------
     1569.6 |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
    1352.16 |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
    1352.16 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
    1352.16 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
    7614.53 |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
    7614.53 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
    7614.53 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
    7614.53 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
    7614.53 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
    5333.02 |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
    5333.02 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

`nth_value` -- 返回窗口框架中的指定值

```text
test=# select nth_value(amount,2) over(partition by begincity order by id),* from bills;
 nth_value | id |       goodsdesc        | beginunit | begincity |       pubtime       | amount  
-----------+----+------------------------+-----------+-----------+---------------------+---------
           |  1 | 衣服                   | 海南省    | 三亚市    | 2015-10-05 09:32:01 |  1569.6
           |  2 | 建筑设备               | 福建省    | 三明市    | 2015-10-05 07:21:22 | 9370.12
   6573.33 |  3 | 设备                   | 福建省    | 三明市    | 2015-10-05 11:21:54 | 6573.33
   6573.33 |  4 | 普货                   | 福建省    | 三明市    | 2015-10-05 15:19:17 | 1352.16
           |  5 | 5 0铲车，后八轮翻斗车  | 河南省    | 三门峡市  | 2015-10-05 07:53:13 | 2350.68
       549 |  6 | 鲜香菇2000斤           | 河南省    | 三门峡市  | 2015-10-05 10:38:29 |     549
       549 |  7 | 旋挖附件38吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4089.25
       549 |  8 | 旋挖附件35吨           | 河南省    | 三门峡市  | 2015-10-05 10:48:38 | 4766.76
       549 | 11 | 旋挖附件39吨           | 河南省    | 三门峡市  | 2015-10-05 11:38:38 | 7614.53
           |  9 | 设备                   | 上海市    | 上海市    | 2015-10-05 07:59:35 | 5094.08
   5333.02 | 10 | 普货40吨需13米半挂一辆 | 上海市    | 上海市    | 2015-10-05 08:13:59 | 5333.02
(11 rows)

test=#
```

统计各个城市的总运费及平均每单的运费

```text
test=# select sum(amount) over(partition by begincity),avg(amount) over(partition by begincity),begincity,amount 
from bills;
   sum    |       avg        | begincity | amount  
----------+------------------+-----------+---------
   1569.6 |           1569.6 | 三亚市    |  1569.6
 17295.61 | 5765.20333333333 | 三明市    | 6573.33
 17295.61 | 5765.20333333333 | 三明市    | 1352.16
 17295.61 | 5765.20333333333 | 三明市    | 9370.12
 19370.22 |         3874.044 | 三门峡市  | 4766.76
 19370.22 |         3874.044 | 三门峡市  | 7614.53
 19370.22 |         3874.044 | 三门峡市  | 2350.68
 19370.22 |         3874.044 | 三门峡市  |     549
 19370.22 |         3874.044 | 三门峡市  | 4089.25
  10427.1 |          5213.55 | 上海市    | 5333.02
  10427.1 |          5213.55 | 上海市    | 5094.08
(11 rows)

test=#
```

窗口函数别名使用
```text
test=# select sum(amount) over w,avg(amount) over w,begincity,amount from bills window w as (partition by begincity);
   sum    |       avg        | begincity | amount  
----------+------------------+-----------+---------
   1569.6 |           1569.6 | 三亚市    |  1569.6
 17295.61 | 5765.20333333333 | 三明市    | 6573.33
 17295.61 | 5765.20333333333 | 三明市    | 1352.16
 17295.61 | 5765.20333333333 | 三明市    | 9370.12
 19370.22 |         3874.044 | 三门峡市  | 4766.76
 19370.22 |         3874.044 | 三门峡市  | 7614.53
 19370.22 |         3874.044 | 三门峡市  | 2350.68
 19370.22 |         3874.044 | 三门峡市  |     549
 19370.22 |         3874.044 | 三门峡市  | 4089.25
  10427.1 |          5213.55 | 上海市    | 5333.02
  10427.1 |          5213.55 | 上海市    | 5094.08
(11 rows)

test=#
```